<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Family Tree</title>
  <style>
    .node rect {
      stroke: #555;
      stroke-width: 1.5px;
    }
    .node text {
      font: 12px sans-serif;
    }
    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }
    .expand-icon {
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
    }
    .highlighted {
      stroke: #00ff00;
      stroke-width: 3px;
      fill: #e0ffe0;
    }
    .details {
      font-size: 10px;
      fill: #333;
    }
  </style>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <div id="tree-container"></div>
  <script type="text/javascript">
    const treeData = JSON.parse(JSON.parse(__TREE_DATA__));
    const debug = false; // Enable for debug logs
    const queryParams = new URLSearchParams(window.location.search);
    const highlightedId = queryParams.get("id");

    const margin = {top: 20, right: 90, bottom: 30, left: 90},
          width = 1200 - margin.left - margin.right,
          height = 800 - margin.top - margin.bottom;

    const svg = d3.select("#tree-container").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    const root = d3.hierarchy(treeData);
    const treeLayout = d3.tree().size([width, height]);
    treeLayout(root);

    svg.selectAll('.link')
        .data(root.links())
        .enter().append('path')
        .attr('class', 'link')
        .attr('d', d3.linkVertical()
            .x(d => d.x)
            .y(d => d.y));

    const node = svg.selectAll('.node')
        .data(root.descendants())
        .enter().append('g')
        .attr('class', 'node')
        .attr('transform', d => `translate(${d.x},${d.y})`);

    node.each(function(d) {
      const g = d3.select(this);
      const isHighlighted = d.data.id === highlightedId;
      if (debug) console.log("Rendering node:", d.data);

      function toggleDetails(nodeGroup, personData, yOffset) {
        const existing = nodeGroup.selectAll(".details");
        if (!existing.empty()) {
          existing.remove();
        } else {
          nodeGroup.append("text")
            .attr("class", "details")
            .attr("x", -65)
            .attr("y", yOffset + 40)
            .text(`DOB: ${personData.dob || 'N/A'}`);

          nodeGroup.append("text")
            .attr("class", "details")
            .attr("x", -65)
            .attr("y", yOffset + 52)
            .text(`Valavu: ${personData.valavu || 'N/A'}`);

          nodeGroup.append("text")
            .attr("class", "details")
            .attr("x", -65)
            .attr("y", yOffset + 64)
            .text(`Alive: ${personData.is_alive ? 'Yes' : 'No'}`);
        }
      }

      function addExpandIcon(x, y, personData, yOffset) {
        g.append("text")
          .attr("class", "expand-icon")
          .attr("x", x)
          .attr("y", y)
          .text("\u25BC")
          .on("click", () => toggleDetails(g, personData, yOffset));
      }

      if (d.data.type === 'couple' && d.data.husband && d.data.wife) {
        g.append('rect')
          .attr('x', -70)
          .attr('y', -35)
          .attr('width', 140)
          .attr('height', 30)
          .attr('fill', d.data.husband.id === highlightedId ? '#ffcccc' : '#e6f0ff')
          .attr('stroke', d.data.husband.id === highlightedId ? 'red' : '#333')
          .attr('stroke-width', d.data.husband.id === highlightedId ? 3 : 1.5);

        const husbandLink = g.append("a")
          .attr("xlink:href", `https://500-family-tree4.streamlit.app/?id=${d.data.husband.id}`)
          .attr("target", "_blank");

        husbandLink.append("text")
          .attr("text-anchor", "middle")
          .attr("dy", "-1em")
          .text(d.data.husband.name || d.data.husband.id)
          .style("fill", "blue")
          .style("text-decoration", "underline")
          .style("cursor", "pointer");

        addExpandIcon(55, -38, d.data.husband, -40);

        g.append('rect')
          .attr('x', -70)
          .attr('y', 0)
          .attr('width', 140)
          .attr('height', 30)
          .attr('fill', d.data.wife.id === highlightedId ? '#ffcccc' : '#ffe6f0')
          .attr('stroke', d.data.wife.id === highlightedId ? 'red' : '#333')
          .attr('stroke-width', d.data.wife.id === highlightedId ? 3 : 1.5);

        const wifeLink = g.append("a")
          .attr("xlink:href", `https://500-family-tree4.streamlit.app/?id=${d.data.wife.id}`)
          .attr("target", "_blank");

        wifeLink.append("text")
          .attr("text-anchor", "middle")
          .attr("dy", "1em")
          .text(d.data.wife.name || d.data.wife.id)
          .style("fill", "blue")
          .style("text-decoration", "underline")
          .style("cursor", "pointer");

        addExpandIcon(55, 2, d.data.wife, 0);

      } else {
        g.append("rect")
          .attr("x", -70)
          .attr("y", -20)
          .attr("width", 140)
          .attr("height", 40)
          .attr("fill", isHighlighted ? "#ffcccc" : (d.data.gender === "F" ? "#ffe6f0" : d.data.gender === "M" ? "#e6f0ff" : "#fff"))
          .attr("stroke", isHighlighted ? "red" : "#333")
          .attr("stroke-width", isHighlighted ? 3 : 1.5);

        if (d.data.url) {
          const link = g.append("a")
              .attr("xlink:href", d.data.url)
              .attr("target", "_blank");

          link.append("text")
              .attr("text-anchor", "middle")
              .attr("dy", "-0.3em")
              .text(d.data.name || d.data.id)
              .style("fill", "blue")
              .style("text-decoration", "underline")
              .style("cursor", "pointer");
        } else {
          g.append("text")
              .attr("text-anchor", "middle")
              .attr("dy", "-0.3em")
              .text(d.data.name || d.data.id);
        }

        addExpandIcon(55, -22, d.data, -20);
      }
    });
  </script>
</body>
</html>
